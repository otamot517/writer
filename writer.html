<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jekyll 文章撰寫介面</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        body { font-family: 'Inter', sans-serif; }
        /* 調整 textarea/input 焦點樣式 */
        .input-focus:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* blue-500 with opacity */
        }
        /* 隱藏 datetime-local 的秒數和時區顯示 */
        input[type="datetime-local"]::-webkit-datetime-edit-second-field { display: none; }
        input[type="datetime-local"]::-webkit-datetime-edit-millisecond-field { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">Jekyll 文章撰寫工具</h1>
        <p class="text-gray-500 mb-8">填寫下列欄位，將自動產生符合 Jekyll 規範的 Markdown 文件，包含 YAML Front Matter。</p>

        <!-- 標題輸入 -->
        <div class="mb-6">
            <label for="postTitle" class="block text-sm font-medium text-gray-700 mb-2">文章標題 (title)</label>
            <input type="text" id="postTitle" placeholder="輸入您的文章標題..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition duration-150 ease-in-out">
        </div>

        <!-- 發布時間輸入 -->
        <div class="mb-6">
            <label for="publishDate" class="block text-sm font-medium text-gray-700 mb-2">發布時間 (date)</label>
            <input type="datetime-local" id="publishDate"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition duration-150 ease-in-out">
            <p class="text-xs text-gray-500 mt-1">此時間將用於 Front Matter 中的 `date` 欄位及檔案命名。</p>
        </div>

        <!-- 內容輸入 -->
        <div class="mb-8">
            <label for="postContent" class="block text-sm font-medium text-gray-700 mb-2">文章內容 (Markdown)</label>
            <textarea id="postContent" rows="15" placeholder="請在此輸入您的文章內容，支援 Markdown 格式..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition duration-150 ease-in-out"></textarea>
        </div>

        <!-- 產生按鈕 -->
        <button id="generateButton" onclick="generateAndDownloadPost()"
                class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            產生並下載 Markdown 檔案
        </button>

        <!-- 訊息顯示區 -->
        <div id="messageArea" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
    </div>

    <script>
        // 設定時區偏移量 (台灣為 UTC+8)
        const TIMEZONE_OFFSET = "+0800";
        // 訊息區元素
        const messageArea = document.getElementById('messageArea');

        /**
         * 頁面載入時，將日期時間輸入欄位設定為當前時間。
         */
        window.onload = function() {
            const now = new Date();
            // 由於 datetime-local 格式要求 'YYYY-MM-DDTHH:MM'，需要手動格式化
            const offset = now.getTimezoneOffset() * 60000; // 轉換成分鐘，再轉成毫秒
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
            document.getElementById('publishDate').value = localISOTime;
        }

        /**
         * 顯示訊息（成功或錯誤）
         * @param {string} msg - 訊息內容
         * @param {string} type - 訊息類型 ('success' or 'error')
         */
        function displayMessage(msg, type) {
            messageArea.textContent = msg;
            messageArea.className = `mt-4 p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageArea.style.display = 'block';
        }

        /**
         * 將標題轉換為適合檔案名稱的 slug (簡寫)
         * @param {string} title - 文章標題
         * @returns {string} - 簡寫字串
         */
        function slugify(title) {
            // 轉換為小寫
            let slug = title.toLowerCase();

            // 移除前後空白
            slug = slug.trim();

            // 移除所有標點符號，但保留連字符 (hyphen) 和空格
            slug = slug.replace(/[^\w\s-]/g, '');

            // 將所有空格、底線或連字符替換為單一連字符
            slug = slug.replace(/[\s_-]+/g, '-');

            // 確保 slug 不以連字符開頭或結尾
            slug = slug.replace(/^-+|-+$/g, '');

            return slug;
        }

        /**
         * 格式化日期為 Jekyll Front Matter 所需的字串
         * 格式: YYYY-MM-DD HH:MM:SS +0800
         * @param {Date} dateObj - Date 物件
         * @returns {string} - 格式化後的日期時間字串
         */
        function formatJekyllDate(dateObj) {
            const pad = (num) => num.toString().padStart(2, '0');

            const year = dateObj.getFullYear();
            const month = pad(dateObj.getMonth() + 1);
            const day = pad(dateObj.getDate());

            const hours = pad(dateObj.getHours());
            const minutes = pad(dateObj.getMinutes());
            const seconds = pad(dateObj.getSeconds());

            // Jekyll Front Matter date format
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${TIMEZONE_OFFSET}`;
        }

        /**
         * 產生並下載 Jekyll Markdown 文件
         */
        function generateAndDownloadPost() {
            messageArea.style.display = 'none'; // 隱藏之前的訊息

            const title = document.getElementById('postTitle').value.trim();
            const dateInput = document.getElementById('publishDate').value;
            const content = document.getElementById('postContent').value;

            if (!title) {
                displayMessage('錯誤：請輸入文章標題。', 'error');
                return;
            }

            if (!dateInput) {
                displayMessage('錯誤：請選擇發布時間。', 'error');
                return;
            }

            // 1. 處理日期
            // dateInput 格式為 'YYYY-MM-DDTHH:MM' (本地時間)
            const dateObj = new Date(dateInput);

            // 格式化 Front Matter 的日期
            const frontMatterDate = formatJekyllDate(dateObj);

            // 格式化檔案名稱的日期 (僅 YYYY-MM-DD)
            const dateForFilename = frontMatterDate.substring(0, 10);

            // 2. 處理 Slug
            const slug = slugify(title);

            // 3. 建立 Front Matter
            const frontMatter = `---
layout: post
title: "${title.replace(/"/g, '\\"')}"
date: ${frontMatterDate}
---

`; // 確保 Front Matter 後有兩個換行符

            // 4. 組合文件內容
            const fileContent = frontMatter + content;

            // 5. 確定檔案名稱
            const filename = `${dateForFilename}-${slug}.md`;

            // 6. 下載檔案
            const blob = new Blob([fileContent], { type: 'text/markdown;charset=utf-8' });

            // 創建一個虛擬連結
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;

            // 觸發下載
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            displayMessage(`成功！檔案 "${filename}" 已產生並下載。`, 'success');
        }
    </script>
</body>
</html>